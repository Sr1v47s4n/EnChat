# views.py
@login_required
def conversations(request):
    """
    Retrieve unique conversations with properly formatted latest messages
    """
    user = request.user

    # Get all conversations where the user is either sender or receiver
    subquery = PrivateMessage.objects.filter(
        Q(sender=OuterRef('sender'), receiver=OuterRef('receiver')) |
        Q(sender=OuterRef('receiver'), receiver=OuterRef('sender'))
    ).order_by('-timestamp')

    # Get unique conversations with latest message
    conversations = (
        PrivateMessage.objects.filter(Q(sender=user) | Q(receiver=user))
        .annotate(
            latest_id=Subquery(
                subquery.values('id')[:1]
            )
        )
        .filter(id=F('latest_id'))
        .select_related('sender', 'receiver')
        .order_by('-timestamp')
        .distinct('sender', 'receiver')
    )

    return render(
        request,
        "chat/conversations.html",
        {"conversations": conversations, "no_conversations": not conversations.exists()}
    )

# Template (conversations.html)
{% for convo in conversations %}
    {% with other_user=convo.receiver %}
        {% if other_user == request.user %}
            {% with other_user=convo.sender %}
                <a href="{% url 'chat' other_user.id %}" class="flex items-center space-x-4 p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition mb-2">
                    <img src="{{ other_user.profile_picture }}" class="w-10 h-10 rounded-full object-cover" alt="{{ other_user.username }}">
                    <div class="flex-1">
                        <p class="font-semibold">{{ other_user.username }}</p>
                        <p class="text-sm text-gray-400 truncate w-48">
                            {% if convo.encrypted_message %}
                                {{ convo.encrypted_message|truncatechars:50 }}
                            {% else %}
                                No messages yet
                            {% endif %}
                        </p>
                    </div>
                    <span class="text-xs text-gray-500">{{ convo.timestamp|date:"H:i" }}</span>
                </a>
            {% endwith %}
        {% else %}
            <a href="{% url 'chat' other_user.id %}" class="flex items-center space-x-4 p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition mb-2">
                <img src="{{ other_user.profile_picture }}" class="w-10 h-10 rounded-full object-cover" alt="{{ other_user.username }}">
                <div class="flex-1">
                    <p class="font-semibold">{{ other_user.username }}</p>
                    <p class="text-sm text-gray-400 truncate w-48">
                        {% if convo.encrypted_message %}
                            {{ convo.encrypted_message|truncatechars:50 }}
                        {% else %}
                            No messages yet
                        {% endif %}
                    </p>
                </div>
                <span class="text-xs text-gray-500">{{ convo.timestamp|date:"H:i" }}</span>
            </a>
        {% endif %}
    {% endwith %}
{% endfor %}