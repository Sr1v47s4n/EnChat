{% extends "base.html" %}

{% block content %}
<div class="flex h-screen bg-gray-900 text-white">
    <!-- Sidebar -->


    <!-- Chat Window -->
    <div class="flex-1 flex flex-col bg-gray-900">
        <!-- Header -->
        <div class="bg-gray-800 px-6 py-3 flex items-center space-x-4 shadow-md">
            <img src="{{ receiver.profile_picture }}" class="w-12 h-12 rounded-full object-cover" alt="User">
            <div>
                <h2 class="text-lg font-semibold">{{ receiver.username }}</h2>
                <p class="text-sm text-gray-400">Online</p>
            </div>
        </div>

        <!-- Messages -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4">
            {% for msg in messages %}
            <div class="{% if msg.sender == request.user.username %}text-right{% else %}text-left{% endif %}">
                <div class="inline-block px-4 py-2 rounded-xl shadow-lg max-w-xs {% if msg.sender == request.user.username %}bg-blue-500 text-white{% else %}bg-gray-700 text-gray-300{% endif %}">
                    {{ msg.message }}
                </div>
                <p class="text-xs text-gray-500 mt-1">
    {{ msg.timestamp|date:"H:i" }}  
    {% if msg.sender == request.user.username %}
        {% if msg.is_read %}
            <span class="text-green-400">✔✔ Read</span>
        {% else %}
            <span class="text-gray-400">✔ Sent</span>
        {% endif %}
    {% endif %}


            </div>

            {% empty %}
            <p class="text-center text-gray-400 text-sm">Start a new conversation!</p>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <form id="messageForm" class="bg-gray-800 p-4 flex items-center" method="POST">
            {% csrf_token %}
            <button type="button" class="text-gray-400 px-3">
                <i class="fas fa-smile"></i>
            </button>
            <input type="text" name="message" id="messageInput" class="flex-1 px-4 py-2 rounded-lg bg-gray-900 text-white focus:outline-none" placeholder="Type a message...">
            <button type="submit" class="ml-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<script>
    document.getElementById("messageForm").addEventListener("submit", function (e) {
        e.preventDefault();
        let messageInput = document.getElementById("messageInput").value.trim();

        if (messageInput === "") {
            alert("Message cannot be empty!");
            return;
        }

        fetch("{% url 'send_message' receiver.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: `message=${encodeURIComponent(messageInput)}`,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("messageInput").value = "";
                location.reload();
            } else {
                alert("Error sending message.");
            }
        });
    });
    
</script>
<script>
function fetchNewMessages() {
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");
            let newMessages = doc.querySelector(".messages-container").innerHTML;
            document.querySelector(".messages-container").innerHTML = newMessages;

            document.querySelectorAll(".message-item").forEach(function (msg) {
                let messageId = msg.getAttribute("data-id");
                let isRead = msg.getAttribute("data-read");

                if (isRead === "False") {
                    fetch(`/chat/read_message/${messageId}/`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCsrfToken(),
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            msg.querySelector(".read-status").innerText = "✔✔ Read";
                        }
                    })
                    .catch(error => console.error("Error:", error));
                }
            });
        })
        .catch(error => console.error("Error fetching messages:", error));
}

// Refresh every 5 seconds
setInterval(fetchNewMessages, 5000);
</script>
{% endblock %}